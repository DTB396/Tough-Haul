<!DOCTYPE html>
<html lang="en">

<head>
  {% include layout/head.html %}
  {% include schema/schema-combined.js %}
  
  {%- assign og_title = page.meta_title | default: page.title | default: site.title -%}
  {%- assign og_desc = page.meta_description | default: page.description | default: site.description -%}
  {%- assign og_image = page.og_image | default: page.featured_image | default: site.default_og_image -%}
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="{{ page.og_type | default: 'website' }}" />
  <meta property="og:site_name" content="{{ site.title }}" />
  <meta property="og:title" content="{{ og_title | escape }}" />
  <meta property="og:description" content="{{ og_desc | strip_html | truncate: 200 | escape }}" />
  <meta property="og:url" content="{{ page.url | absolute_url }}" />
  <meta property="og:image" content="{{ og_image | absolute_url }}" />
  <meta property="og:locale" content="en_US" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="{{ page.twitter_card | default: 'summary_large_image' }}" />
  <meta name="twitter:site" content="@{{ site.social.twitter | default: 'webdevpro' }}" />
  <meta name="twitter:title" content="{{ og_title | escape }}" />
  <meta name="twitter:description" content="{{ og_desc | strip_html | truncate: 200 | escape }}" />
  <meta name="twitter:image" content="{{ og_image | absolute_url }}" />
  
  <!-- Geo/Local SEO - Update these values for your location -->
  {% if site.company.geo %}
  <meta name="geo.region" content="{{ site.company.geo.region | default: 'US' }}" />
  <meta name="geo.placename" content="{{ site.company.geo.placename }}" />
  <meta name="geo.position" content="{{ site.company.geo.position }}" />
  <meta name="ICBM" content="{{ site.company.geo.icbm }}" />
  {% endif %}
  
  <!-- Canonical -->
  <link rel="canonical" href="{{ page.canonical_url | default: page.url | absolute_url }}" />
  {% if page.url == "/contact/" %}

  {% include forms/contact-page.html %}
  {% endif %}

  {% if page.permalink == "/success/" %}
  <script>
    (function () {
      const confettiRoot = document.getElementById("confetti");
      const partyBtn = document.getElementById("partyBtn");
      function burst(count) {
        if (!confettiRoot) return;
        // XSS-safe: Clear children without innerHTML
        while (confettiRoot.firstChild) {
          confettiRoot.removeChild(confettiRoot.firstChild);
        }
        const reduce =
          window.matchMedia &&
          window.matchMedia("(prefers-reduced-motion: reduce)").matches;
        if (reduce) return;
        const colors = [
          "#0b6cff",
          "#10b981",
          "#f59e0b",
          "#ef4444",
          "#a855f7",
          "#14b8a6",
        ];
        for (let i = 0; i < count; i++) {
          const piece = document.createElement("i");
          const x = Math.floor(Math.random() * 100) + "vw";
          const dx = (Math.random() * 40 - 20).toFixed(1) + "vw";
          const r = Math.floor(Math.random() * 360) + "deg";
          const d = (Math.random() * 1.2 + 1.3).toFixed(2) + "s";
          piece.style.setProperty("--x", x);
          piece.style.setProperty("--dx", dx);
          piece.style.setProperty("--r", r);
          piece.style.setProperty("--d", d);
          piece.style.background =
            colors[Math.floor(Math.random() * colors.length)];
          if (Math.random() > 0.7) {
            piece.style.width = "12px";
            piece.style.height = "12px";
            piece.style.borderRadius = "999px";
          } else if (Math.random() > 0.7) {
            piece.style.height = "20px";
          }
          confettiRoot.appendChild(piece);
        }
        window.setTimeout(() => {
          // XSS-safe: Clear children without innerHTML
          while (confettiRoot.firstChild) {
            confettiRoot.removeChild(confettiRoot.firstChild);
          }
        }, 3200);
      }
      window.setTimeout(() => burst(42), 180);
      if (partyBtn) partyBtn.addEventListener("click", () => burst(55));
    })();
  </script>
  {% endif %}
  </head>

<body class="ts-body{% if page.body_class %} {{ page.body_class }}{% endif %}{% if layout.body_class %} {{ layout.body_class }}{% endif %}{% if page.build_guide %} page-build-guide{% endif %}">
  <!-- Skip Links for Accessibility - Multiple Targets -->
  <nav class="skip-links" aria-label="Skip navigation">
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <a href="#footer-contact-heading" class="skip-link">Skip to contact</a>
  </nav>

  {% include layout/header.html %}

  {% unless page.build_guide %}
  {% include navigation/ts-breadcrumbs.html %}
  {% endunless %}

  {% comment %} Build Guide Hero - opt-in via front matter build_guide: true {% endcomment %}
  {% if page.build_guide %}
  {%- assign phase_order = page.order | default: page.build_order -%}
  {%- assign phases = site.data.build_phases.build_phases | sort: "order" -%}
  <section class="build-hero">
    <div class="container">
      <nav class="build-breadcrumb" aria-label="Breadcrumb">
        <a href="/build/">Build Guides</a>
        {% if phase_order %}
        <span aria-hidden="true">›</span>
        <span>Phase {{ phase_order }}</span>
        {% endif %}
      </nav>
      {% if phase_order %}<span class="phase-badge">Phase {{ phase_order }} of 8</span>{% endif %}
      <h1 class="build-hero-title">{{ page.build_title | default: page.title }}</h1>
      {% if page.description %}<p class="build-hero-desc">{{ page.description }}</p>{% endif %}
    </div>
  </section>
  {% endif %}

  <main class="ts-main-content" role="main" id="main-content" aria-label="Main content">
    {% if page.build_guide and page.toc %}
    <div class="container">
      <div class="build-layout">
        <aside class="build-toc" aria-label="Table of Contents">
          <h2 class="toc-title">On This Page</h2>
          <nav class="toc-nav" id="toc-nav"></nav>
        </aside>
        <article class="build-article prose">
          {{ content }}
        </article>
      </div>
    </div>
    {% elsif page.build_guide %}
    <div class="container">
      <article class="build-article prose" style="max-width: 800px; margin: 0 auto;">
        {{ content }}
      </article>
    </div>
    {% else %}
    {{ content }}
    {% endif %}
  </main>

  {% comment %} Build Guide Phase Navigation {% endcomment %}
  {% if page.build_guide %}
  {%- assign phase_order = page.order | default: page.build_order -%}
  {%- assign phases = site.data.build_phases.build_phases | sort: "order" -%}
  {%- assign prev_order = phase_order | minus: 1 -%}
  {%- assign next_order = phase_order | plus: 1 -%}
  {%- assign prev_phase = nil -%}
  {%- assign next_phase = nil -%}
  {%- for phase in phases -%}
    {%- if phase.order == prev_order -%}{%- assign prev_phase = phase -%}{%- endif -%}
    {%- if phase.order == next_order -%}{%- assign next_phase = phase -%}{%- endif -%}
  {%- endfor -%}
  <section class="build-phase-nav ts-section">
    <div class="container">
      <nav class="phase-nav-links" aria-label="Build Phase Navigation">
        {% if prev_phase %}
        <a href="{{ prev_phase.url | relative_url }}" class="phase-link phase-prev">
          <span class="phase-label">← Previous</span>
          <span class="phase-title">Phase {{ prev_phase.order }}: {{ prev_phase.title }}</span>
        </a>
        {% else %}
        <a href="/build/" class="phase-link phase-prev">
          <span class="phase-label">← Back</span>
          <span class="phase-title">All Build Guides</span>
        </a>
        {% endif %}
        {% if next_phase %}
        <a href="{{ next_phase.url | relative_url }}" class="phase-link phase-next">
          <span class="phase-label">Next →</span>
          <span class="phase-title">Phase {{ next_phase.order }}: {{ next_phase.title }}</span>
        </a>
        {% else %}
        <a href="/contact/" class="phase-link phase-next phase-cta">
          <span class="phase-label">Ready to Build?</span>
          <span class="phase-title">Request an Estimate</span>
        </a>
        {% endif %}
      </nav>
    </div>
  </section>

  <section class="build-cta">
    <div class="container text-center">
      <h2>Ready to Start Your Project?</h2>
      <p>Get a free consultation and project quote from our expert team.</p>
      <div class="cta-buttons">
        <a href="/contact/" class="btn btn-light btn-lg">Get a Free Quote</a>
        <a href="tel:+15551234567" class="btn btn-outline-light btn-lg">Call (555) 123-4567</a>
      </div>
      <p class="cta-cred"><small>Licensed &amp; Insured • Industry Best Practices</small></p>
    </div>
  </section>
  {% endif %}

  {% include layout/footer.html %}

  <!-- Accessibility Toolbar (enable with ?a11y-tools in URL) -->
  {% include components/a11y-toolbar.html %}

  <!-- Service Worker Registration for Offline Support -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('[SW] Registered:', reg.scope))
          .catch(err => console.warn('[SW] Registration failed:', err));
      });
    }
  </script>
</body>

</html>